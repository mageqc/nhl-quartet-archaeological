#!/usr/bin/env python3
"""
üèõÔ∏èüíé NHL QUARTET ARCHAEOLOGICAL APP - INTERFACE GRAPHIQUE COMPL√àTE üñ•Ô∏èüöÄ
App web interactive pour exploiter tous les tr√©sors arch√©ologiques d√©couverts

FEATURES:
- üìä Dashboard analyses du jour
- üîÆ Matchs √† venir avec probabilit√©s quartet  
- üìà R√©sultats de la veille et validation
- üí∞ Tracking bankroll et ROI
- üèõÔ∏è Tous les tr√©sors arch√©ologiques int√©gr√©s
- üî• X hype live (Demidov/Hutson)
- ü§ñ Quartet IA fusion (Grok+Gemini+ChatGPT+Copilot)
"""

import sqlite3
import json
import random
import statistics
from datetime import datetime, timedelta
from flask import Flask, render_template, jsonify, request
import threading
import time

# Import notre syst√®me quartet
from quartet_archaeological_simple import QuartetArchaeologicalSimple

class NHLQuartetApp:
    """üèõÔ∏è Application web NHL avec tr√©sors arch√©ologiques"""
    
    def __init__(self):
        self.app = Flask(__name__)
        self.quartet_engine = QuartetArchaeologicalSimple(bankroll=1000)
        
        # Donn√©es simul√©es pour demo (en prod = NHL API)
        self.current_games = []
        self.upcoming_games = []
        self.yesterday_results = []
        self.bankroll_history = []
        
        self.setup_routes()
        self.generate_demo_data()
        
    def generate_demo_data(self):
        """G√©n√®re donn√©es demo pour l'app"""
        
        # Matchs du jour (analyses live)
        self.current_games = [
            {
                'home': 'MTL', 'away': 'TOR', 'time': '19:00 ET',
                'status': 'ANALYZING', 'hype_level': 'MAXIMUM'
            },
            {
                'home': 'BOS', 'away': 'NYR', 'time': '19:30 ET', 
                'status': 'READY', 'hype_level': 'HIGH'
            }
        ]
        
        # Matchs √† venir (pr√©dictions quartet)
        tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
        day_after = (datetime.now() + timedelta(days=2)).strftime('%Y-%m-%d')
        
        self.upcoming_games = [
            {'home': 'MTL', 'away': 'WPG', 'date': tomorrow, 'time': '19:00 ET'},
            {'home': 'MTL', 'away': 'PIT', 'date': day_after, 'time': '19:30 ET'},
            {'home': 'TOR', 'away': 'BOS', 'date': day_after, 'time': '20:00 ET'}
        ]
        
        # R√©sultats d'hier (validation)
        yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')
        self.yesterday_results = [
            {
                'home': 'MTL', 'away': 'OTT', 'date': yesterday,
                'final_score': 'MTL 4-2 OTT', 'predicted_prob': 0.65,
                'actual_result': 'WIN', 'roi': '+12.5%', 'bet_result': 'WIN'
            },
            {
                'home': 'BOS', 'away': 'PHI', 'date': yesterday,
                'final_score': 'BOS 3-1 PHI', 'predicted_prob': 0.58,
                'actual_result': 'WIN', 'roi': '+8.2%', 'bet_result': 'WIN'
            }
        ]
        
        # Bankroll history
        base_bankroll = 1000
        for i in range(10):
            date = (datetime.now() - timedelta(days=9-i)).strftime('%Y-%m-%d')
            roi = random.uniform(-5, 15)  # -5% √† +15% daily
            balance = base_bankroll * (1 + roi/100)
            
            self.bankroll_history.append({
                'date': date,
                'balance': balance,
                'daily_roi': roi,
                'profit': balance - base_bankroll
            })
            base_bankroll = balance
            
    def setup_routes(self):
        """Setup routes Flask pour l'app"""
        
        @self.app.route('/')
        def dashboard():
            return self.render_dashboard()
            
        @self.app.route('/api/current_analysis')
        def api_current_analysis():
            """API pour analyses du jour"""
            analyses = []
            
            for game in self.current_games:
                # G√©n√©rer analyse quartet pour chaque match
                prediction = self.quartet_engine.quartet_ultimate_prediction(
                    game['home'], game['away'], datetime.now().strftime('%Y-%m-%d')
                )
                
                analyses.append({
                    'game': f"{game['home']} vs {game['away']}",
                    'time': game['time'],
                    'quartet_prob': round(prediction['quartet_final_prob'], 3),
                    'grok_hype': round(prediction['grok_x_hype'], 3),
                    'gemini_patterns': prediction['gemini_patterns'],
                    'chatgpt_ev': round(prediction['chatgpt_ev'], 3),
                    'copilot_kelly': round(prediction['copilot_kelly'], 3),
                    'recommendation': prediction['quartet_recommendation'],
                    'bet_size': round(prediction['quartet_bet_size'], 0),
                    'roi_projection': round(prediction['quartet_roi_projection'], 1),
                    'confidence': prediction['quartet_confidence_level'],
                    'hype_level': game['hype_level']
                })
                
            return jsonify({'analyses': analyses})
            
        @self.app.route('/api/upcoming_games')
        def api_upcoming_games():
            """API pour matchs √† venir"""
            predictions = []
            
            for game in self.upcoming_games:
                prediction = self.quartet_engine.quartet_ultimate_prediction(
                    game['home'], game['away'], game['date']
                )
                
                predictions.append({
                    'game': f"{game['home']} vs {game['away']}",
                    'date': game['date'],
                    'time': game['time'],
                    'quartet_prob': round(prediction['quartet_final_prob'], 3),
                    'recommendation': prediction['quartet_recommendation'],
                    'bet_size': round(prediction['quartet_bet_size'], 0),
                    'roi_projection': round(prediction['quartet_roi_projection'], 1),
                    'confidence': prediction['quartet_confidence_level'],
                    'treasures_active': prediction['treasures_used']
                })
                
            return jsonify({'upcoming': predictions})
            
        @self.app.route('/api/yesterday_results')
        def api_yesterday_results():
            """API pour r√©sultats d'hier"""
            return jsonify({'results': self.yesterday_results})
            
        @self.app.route('/api/bankroll_tracking')
        def api_bankroll_tracking():
            """API pour tracking bankroll"""
            current_balance = self.bankroll_history[-1]['balance'] if self.bankroll_history else 1000
            total_profit = current_balance - 1000
            avg_roi = statistics.mean([h['daily_roi'] for h in self.bankroll_history[-7:]])
            
            return jsonify({
                'current_balance': round(current_balance, 2),
                'total_profit': round(total_profit, 2),
                'total_roi': round((total_profit / 1000) * 100, 1),
                'avg_daily_roi': round(avg_roi, 1),
                'history': self.bankroll_history[-10:],  # Last 10 days
                'quartet_performance': {
                    'blockchain_blocks': len(self.quartet_engine.copilot_blockchain),
                    'treasures_deployed': 4,
                    'civilization_level': 'ULTIMATE_COSMIC'
                }
            })
            
        @self.app.route('/api/archaeological_summary')
        def api_archaeological_summary():
            """API pour r√©sum√© des tr√©sors arch√©ologiques"""
            summary = self.quartet_engine.quartet_performance_summary()
            
            return jsonify({
                'quartet_ais': summary['quartet_ais'],
                'treasures': summary['treasures_discovered'],
                'civilization_level': summary['civilization_level'],
                'stats': {
                    'total_predictions': len(self.quartet_engine.copilot_blockchain),
                    'avg_confidence': 0.78,
                    'success_rate': 0.73,
                    'total_roi': '+18.2%'
                }
            })
            
    def render_dashboard(self):
        """Render dashboard HTML principal"""
        return '''
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è NHL Quartet Archaeological App üíé</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .game-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #FFD700;
        }

        .game-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .game-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .recommendation {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .strong-bet { background: #28a745; }
        .value-bet { background: #ffc107; color: #000; }
        .pass { background: #6c757d; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .quartet-badge {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4);
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin: 0 3px;
        }

        .treasure-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #FFD700;
            border-radius: 50%;
            margin: 0 2px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .refresh-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 0;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è NHL Quartet Archaeological App üíé</h1>
        <p>üî• Grok + üîÆ Gemini + üí¨ ChatGPT + ü§ñ Copilot = Mine d'Or Cosmique ! üöÄ</p>
        <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh All Data</button>
    </div>

    <div class="container">
        <!-- Analyses du Jour -->
        <div class="card">
            <h2>üìä Analyses du Jour <span class="treasure-indicator"></span></h2>
            <div id="current-analyses" class="loading">
                Chargement des analyses quartet en cours... üèõÔ∏è
            </div>
        </div>

        <!-- Matchs √† Venir -->
        <div class="card">
            <h2>üîÆ Matchs √† Venir <span class="treasure-indicator"></span></h2>
            <div id="upcoming-games" class="loading">
                Pr√©dictions quartet en cours... üíé
            </div>
        </div>

        <!-- R√©sultats d'Hier -->
        <div class="card">
            <h2>üìà R√©sultats de la Veille <span class="treasure-indicator"></span></h2>
            <div id="yesterday-results" class="loading">
                Validation des r√©sultats... ‚úÖ
            </div>
        </div>

        <!-- Bankroll Tracking -->
        <div class="card">
            <h2>üí∞ Bankroll & ROI <span class="treasure-indicator"></span></h2>
            <div id="bankroll-tracking" class="loading">
                Calcul des profits... üìà
            </div>
        </div>

        <!-- R√©sum√© Arch√©ologique -->
        <div class="card full-width">
            <h2>üèõÔ∏è Tr√©sors Arch√©ologiques Actifs <span class="treasure-indicator"></span></h2>
            <div id="archaeological-summary" class="loading">
                Inventaire des tr√©sors d√©couverts... üíé
            </div>
        </div>
    </div>

    <script>
        // Auto-refresh toutes les 30 secondes
        setInterval(refreshAll, 30000);
        
        // Charger donn√©es au startup
        window.onload = function() {
            refreshAll();
        };
        
        function refreshAll() {
            loadCurrentAnalyses();
            loadUpcomingGames();
            loadYesterdayResults();
            loadBankrollTracking();
            loadArchaeologicalSummary();
        }
        
        function loadCurrentAnalyses() {
            fetch('/api/current_analysis')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('current-analyses');
                    let html = '';
                    
                    data.analyses.forEach(analysis => {
                        html += `
                            <div class="game-item">
                                <div class="game-header">
                                    <span class="game-title">${analysis.game}</span>
                                    <span class="recommendation ${analysis.recommendation.toLowerCase().replace('_', '-')}">${analysis.recommendation}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                                    <div><strong>üèÜ Quartet:</strong> ${(analysis.quartet_prob * 100).toFixed(1)}%</div>
                                    <div><strong>üí∞ Bet Size:</strong> $${analysis.bet_size}</div>
                                    <div><strong>üî• Grok Hype:</strong> ${(analysis.grok_hype * 100).toFixed(1)}%</div>
                                    <div><strong>üìà ROI:</strong> ${analysis.roi_projection}%</div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <span class="quartet-badge">üî• Grok</span>
                                    <span class="quartet-badge">üîÆ Gemini</span>
                                    <span class="quartet-badge">üí¨ ChatGPT</span>
                                    <span class="quartet-badge">ü§ñ Copilot</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('current-analyses').innerHTML = '<p>‚ö†Ô∏è Erreur chargement analyses</p>';
                });
        }
        
        function loadUpcomingGames() {
            fetch('/api/upcoming_games')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('upcoming-games');
                    let html = '';
                    
                    data.upcoming.forEach(game => {
                        html += `
                            <div class="game-item">
                                <div class="game-header">
                                    <span class="game-title">${game.game}</span>
                                    <span class="recommendation ${game.recommendation.toLowerCase().replace('_', '-')}">${game.recommendation}</span>
                                </div>
                                <div><strong>üìÖ Date:</strong> ${game.date} ${game.time}</div>
                                <div><strong>üéØ Probabilit√©:</strong> ${(game.quartet_prob * 100).toFixed(1)}%</div>
                                <div><strong>üí∏ Bet Size:</strong> $${game.bet_size}</div>
                                <div><strong>üìä ROI Projet√©:</strong> ${game.roi_projection}%</div>
                                <div style="margin-top: 8px;">
                                    ${game.treasures_active.map(treasure => 
                                        `<span style="color: #FFD700;">üíé ${treasure}</span>`
                                    ).join(' ')}
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('upcoming-games').innerHTML = '<p>‚ö†Ô∏è Erreur chargement pr√©dictions</p>';
                });
        }
        
        function loadYesterdayResults() {
            fetch('/api/yesterday_results')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('yesterday-results');
                    let html = '';
                    
                    data.results.forEach(result => {
                        const winClass = result.bet_result === 'WIN' ? 'value-bet' : 'pass';
                        html += `
                            <div class="game-item">
                                <div class="game-header">
                                    <span class="game-title">${result.home} vs ${result.away}</span>
                                    <span class="recommendation ${winClass}">${result.bet_result}</span>
                                </div>
                                <div><strong>üèí Score Final:</strong> ${result.final_score}</div>
                                <div><strong>üéØ Pr√©diction:</strong> ${(result.predicted_prob * 100).toFixed(1)}%</div>
                                <div><strong>üí∞ ROI R√©alis√©:</strong> ${result.roi}</div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('yesterday-results').innerHTML = '<p>‚ö†Ô∏è Erreur chargement r√©sultats</p>';
                });
        }
        
        function loadBankrollTracking() {
            fetch('/api/bankroll_tracking')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('bankroll-tracking');
                    
                    const html = `
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">$${data.current_balance}</div>
                                <div class="stat-label">Balance Actuelle</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.total_roi}%</div>
                                <div class="stat-label">ROI Total</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">$${data.total_profit}</div>
                                <div class="stat-label">Profit Total</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.avg_daily_roi}%</div>
                                <div class="stat-label">ROI Moyen 7j</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>üèõÔ∏è Performance Quartet:</strong><br>
                            üîó ${data.quartet_performance.blockchain_blocks} blocs blockchain<br>
                            üíé ${data.quartet_performance.treasures_deployed} tr√©sors d√©ploy√©s<br>
                            üåå Niveau: ${data.quartet_performance.civilization_level}
                        </div>
                    `;
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('bankroll-tracking').innerHTML = '<p>‚ö†Ô∏è Erreur chargement bankroll</p>';
                });
        }
        
        function loadArchaeologicalSummary() {
            fetch('/api/archaeological_summary')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('archaeological-summary');
                    
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
                    
                    // Quartet IA
                    html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">';
                    html += '<h3 style="color: #FFD700; margin-bottom: 10px;">ü§ñ Quartet IA Active</h3>';
                    for (const [ia, description] of Object.entries(data.quartet_ais)) {
                        html += `<div style="margin: 5px 0;"><strong>${ia}:</strong> ${description}</div>`;
                    }
                    html += '</div>';
                    
                    // Tr√©sors
                    html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">';
                    html += '<h3 style="color: #FFD700; margin-bottom: 10px;">üíé Tr√©sors D√©ploy√©s</h3>';
                    data.treasures.forEach(treasure => {
                        html += `<div style="margin: 5px 0;">‚úÖ ${treasure}</div>`;
                    });
                    html += '</div>';
                    
                    // Stats
                    html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">';
                    html += '<h3 style="color: #FFD700; margin-bottom: 10px;">üìä Statistiques</h3>';
                    html += `<div><strong>Pr√©dictions:</strong> ${data.stats.total_predictions}</div>`;
                    html += `<div><strong>Confiance Moy:</strong> ${(data.stats.avg_confidence * 100).toFixed(1)}%</div>`;
                    html += `<div><strong>Taux Succ√®s:</strong> ${(data.stats.success_rate * 100).toFixed(1)}%</div>`;
                    html += `<div><strong>ROI Total:</strong> ${data.stats.total_roi}</div>`;
                    html += '</div>';
                    
                    html += '</div>';
                    html += `<div style="text-align: center; margin-top: 20px; font-size: 1.2em;"><strong>üåå Niveau Civilisation: ${data.civilization_level}</strong></div>`;
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('archaeological-summary').innerHTML = '<p>‚ö†Ô∏è Erreur chargement r√©sum√©</p>';
                });
        }
    </script>
</body>
</html>
        '''
        
    def run(self):
        """Lance l'application web"""
        print("üèõÔ∏èüíé Lancement NHL QUARTET ARCHAEOLOGICAL APP sur http://localhost:5000 üöÄ")
        print("üî• Grok + üîÆ Gemini + üí¨ ChatGPT + ü§ñ Copilot = Interface Graphique Ultime!")
        self.app.run(debug=True, host='0.0.0.0', port=5000)

if __name__ == "__main__":
    app = NHLQuartetApp()
    app.run()
